#!/usr/bin/env bash

# get the absolute path of the executable
SELF_PATH=$(cd -P -- "$(dirname -- "$0")" && pwd -P) && SELF_PATH="$SELF_PATH/$(basename -- "$0")"

# resolve symlinks
while [ -h "$SELF_PATH" ]; do
    DIR=$(dirname -- "$SELF_PATH")
    SYM=$(readlink -- "$SELF_PATH")
    SELF_PATH=$(cd -- "$DIR" && cd -- $(dirname -- "$SYM") && pwd)/$(basename -- "$SYM")
done

# NARWHAL_ENGINE_HOME is the 2nd ancestor directory of this shell script
export NARWHAL_ENGINE_HOME=$(dirname -- "$(dirname -- "$SELF_PATH")")

# determine mode
name="$(basename $0)"
if [ "$name" == "narwhal-jsc" ]; then
	if [ -z "$NARWHAL_JSC_MODE" ] && [ -f "$NARWHAL_ENGINE_HOME/narwhal-jsc.conf" ]; then
	    source "$NARWHAL_ENGINE_HOME/narwhal-jsc.conf"
	fi
	if [ -z "$NARWHAL_JSC_MODE" ]; then
	    NARWHAL_JSC_MODE="narwhal-jscore"
	fi
else
	NARWHAL_JSC_MODE="$name"
fi

if [ "$NARWHAL_JSC_MODE" == "narwhal-webkit" ]; then
	for mode in narwhal-webkit-cocoa narwhal-webkit-gtk; do
		if [ -x "$NARWHAL_ENGINE_HOME/executables/$mode" ]; then
			NARWHAL_JSC_MODE="$mode"
			break
		fi
	done
fi

export LD_LIBRARY_PATH="$NARWHAL_ENGINE_HOME/lib:$LD_LIBRARY_PATH"
export DYLD_LIBRARY_PATH="$NARWHAL_ENGINE_HOME/lib:$DYLD_LIBRARY_PATH"

exec "$NARWHAL_ENGINE_HOME/executables/$NARWHAL_JSC_MODE" "$@"
